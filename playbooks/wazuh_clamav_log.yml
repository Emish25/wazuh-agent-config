---
- hosts: linux_servers
  become: true
  become_method: sudo
  become_user: root
  become_flags: '-H'

  vars:
    ansible_remote_tmp: /tmp/.ansible

  environment:
    ANSIBLE_REMOTE_TEMP: /tmp/.ansible
    ANSIBLE_HOST_KEY_CHECKING: "False"

  tasks:
    - name: Clean existing logging configuration from clamd
      lineinfile:
        path: /etc/clamav/clamd.conf
        regexp: '^(LogFile|LogTime|LogRotate|LogVerbose|LogSyslog) '
        state: absent

    - name: Configure ClamAV for Wazuh file logging
      blockinfile:
        path: /etc/clamav/clamd.conf
        marker: "# {mark} WAZUH INTEGRATION"
        block: |
          # WAZUH INTEGRATION - Log to file for Wazuh monitoring
          LogSyslog false
          LogFile /var/log/clamav/clamav.log
          LogTime true
          LogRotate false
          LogVerbose false
          LogFileUnlock false

    - name: Clean existing logging configuration from freshclam
      lineinfile:
        path: /etc/clamav/freshclam.conf
        regexp: '^(LogFile|LogTime|LogRotate|LogVerbose|LogSyslog) '
        state: absent

    - name: Configure freshclam for Wazuh file logging
      blockinfile:
        path: /etc/clamav/freshclam.conf
        marker: "# {mark} WAZUH INTEGRATION"
        block: |
          # WAZUH INTEGRATION - Log to file for Wazuh monitoring
          LogSyslog false
          LogFile /var/log/clamav/clamav.log
          LogTime true
          LogRotate false
          LogVerbose false

    - name: Ensure ClamAV log file exists with correct permissions
      file:
        path: /var/log/clamav/clamav.log
        state: touch
        owner: clamav
        group: clamav
        mode: '0644'

    - name: Restart ClamAV services
      systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - clamav-daemon
        - clamav-freshclam

    - name: Backup ossec.conf
      copy:
        src: /var/ossec/etc/ossec.conf
        dest: /var/ossec/etc/ossec.conf.bak
        remote_src: yes

    - name: Add ClamAV localfile to ossec.conf
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        insertbefore: "</ossec_config>"
        marker: '<!-- {mark} ANSIBLE CLAMAV LOG -->'
        block: |
          <localfile>
            <log_format>syslog</log_format>
            <location>/var/log/clamav/clamav.log</location>
          </localfile>

    - name: Generate test ClamAV event
      command: |
        echo "X5O!P%@AP[4\\PZX54(P^)7CC)7}\$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!\$H+H*" > /tmp/wazuh-test.txt
        clamscan --verbose /tmp/wazuh-test.txt
      register: clamscan_test
      changed_when: false
      ignore_errors: yes

    - name: Display ClamAV logs for verification
      command: tail -10 /var/log/clamav/clamav.log
      register: clamav_logs
      changed_when: false

    - debug:
        msg: |
          ClamAV logs for Wazuh:
          {{ clamav_logs.stdout_lines | join('\n') }}

    - name: Restart wazuh-agent
      systemd:
        name: wazuh-agent
        state: restarted
        enabled: yes

    - name: Wait for Wazuh to process logs
      pause:
        seconds: 5

    - name: Check if Wazuh detected ClamAV logs
      command: sudo tail -20 /var/ossec/logs/ossec.log | grep -i "clamav\|logcollector.*clamav"
      register: wazuh_detection
      changed_when: false
      ignore_errors: yes

    - debug:
        msg: |
          Wazuh detection result:
          {{ wazuh_detection.stdout if wazuh_detection.stdout != '' else 'No ClamAV detection in Wazuh logs yet. Check /var/ossec/logs/alerts/alerts.log' }}
